{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="text-primary fw-bold">Dispatch Board</h2>
        <p class="text-muted mb-0">Manage and dispatch approved orders.</p>
    </div>
    <div class="btn-group shadow-sm">
        <button class="btn btn-outline-primary active" onclick="loadOrders()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</div>

<!-- Key Metrics -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 border-start border-4 border-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small fw-bold text-uppercase">Ready for Dispatch</p>
                        <h3 class="mb-0 fw-bold" id="countApproved">-</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-box-seam text-primary fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm border-0 border-start border-4 border-success">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <p class="text-muted mb-1 small fw-bold text-uppercase">Dispatched Today</p>
                        <h3 class="mb-0 fw-bold" id="countDispatched">-</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                        <i class="bi bi-truck text-success fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Orders Table -->
    <div class="col-lg-8">
        <div class="card shadow-sm h-100">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Invoice #</th>
                                <th>Customer</th>
                                <th>Seller</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Approved At</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">Loading orders...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- In Transit Widget -->
    <div class="col-lg-4">
        <div class="card shadow-sm h-100 border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">In Transit Cloud</h5>
                <span class="badge bg-warning text-dark" id="in-transit-count">0</span>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush" id="in-transit-list"
                    style="max-height: 600px; overflow-y: auto;">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <p class="small mt-2">Loading fleet...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dispatch Modal -->
<div class="modal fade" id="dispatchModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Dispatch Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="dispatchForm">
                <div class="modal-body p-4">
                    <input type="hidden" id="dispatchSaleId">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Assign Store Keeper</label>
                        <select class="form-select" id="storeKeeperSelect" required>
                            <option value="">Select Store Keeper...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Vehicle</label>
                        <select class="form-select mb-2" id="vehicleSelect">
                            <option value="">Select Vehicle...</option>
                        </select>
                        <input type="text" class="form-control" id="lorryInfo"
                            placeholder="Or enter info manually (e.g. rented truck)">
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Confirm Dispatch</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/static/js/api_service.js"></script>
<script>
    const api = new ApiService();
    const dispatchModal = new bootstrap.Modal(document.getElementById('dispatchModal'));

    document.addEventListener('DOMContentLoaded', () => {
        loadOrders();
        loadStoreKeepers();
        loadVehicles();
        loadInTransitVehicles();

        document.getElementById('dispatchForm').addEventListener('submit', (e) => {
            e.preventDefault();
            confirmDispatch();
        });

        setInterval(() => {
            loadOrders();
            loadInTransitVehicles();
        }, 30000);
    });

    async function loadOrders() {
        try {
            const data = await api.get('/api/sales/');
            const orders = Array.isArray(data) ? data : data.results;

            // Only care about Approved and Dispatched
            const approved = orders.filter(o => o.status === 'approved');
            const dispatched = orders.filter(o => o.status === 'dispatched');

            // Update Counts
            document.getElementById('countApproved').innerText = approved.length;
            const today = new Date().toDateString();
            document.getElementById('countDispatched').innerText = dispatched.filter(o => {
                return new Date(o.created_at).toDateString() === today; // Approximation, better if dispatched_at exists
            }).length;

            renderTable([...approved, ...dispatched]);
        } catch (e) {
            console.error(e);
            document.getElementById('ordersTableBody').innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Failed to load orders</td></tr>`;
        }
    }

    function renderTable(orders) {
        const tbody = document.getElementById('ordersTableBody');
        tbody.innerHTML = '';

        // Filter: Show Approved first, then Dispatched
        orders.sort((a, b) => {
            if (a.status === 'approved' && b.status !== 'approved') return -1;
            if (a.status !== 'approved' && b.status === 'approved') return 1;
            return new Date(b.created_at) - new Date(a.created_at);
        });

        if (orders.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">No active dispatch tasks found</td></tr>`;
            return;
        }

        orders.forEach(o => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-4 fw-bold">#${o.invoice_number}</td>
                <td>${o.customer_name}</td>
                <td><small class="text-muted">${o.created_by_name || 'System'}</small></td>
                <td>TZS ${parseFloat(o.total_amount).toLocaleString()}</td>
                <td>${getStatusBadge(o.status)}</td>
                <td>${o.approved_at ? new Date(o.approved_at).toLocaleString() : '-'}</td>
                <td class="text-end pe-4">
                    ${getActionButtons(o)}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function getStatusBadge(status) {
        if (status === 'approved') return '<span class="badge bg-primary">Ready for Dispatch</span>';
        if (status === 'dispatched') return '<span class="badge bg-success">Dispatched</span>';
        return `<span class="badge bg-secondary">${status}</span>`;
    }

    function getActionButtons(o) {
        if (o.status === 'approved') {
            return `
                <a href="/api/sales/${o.id}/receipt/" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                    <i class="bi bi-file-pdf"></i> View Invoice
                </a>
                <button class="btn btn-sm btn-primary" onclick="openDispatchModal(${o.id})">
                    <i class="bi bi-truck"></i> Dispatch
                </button>
            `;
        } else if (o.status === 'dispatched') {
            return `
                 <a href="/api/sales/${o.id}/delivery_note/" target="_blank" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-truck-flatbed"></i> Delivery Note
                </a>
            `;
        }
        return '';
    }

    async function loadStoreKeepers() {
        try {
            const data = await api.get('/api/users/?role=store_keeper');
            const users = Array.isArray(data) ? data : data.results;
            const select = document.getElementById('storeKeeperSelect');

            // Assume any user can be a store keeper for now, or filter if role exists
            users.forEach(u => {
                select.add(new Option(u.username, u.id));
            });
        } catch (e) { console.error('Failed to load users', e); }
    }

    async function loadVehicles() {
        try {
            const data = await api.get('/api/vehicles/');
            const vehicles = Array.isArray(data) ? data : data.results;
            const select = document.getElementById('vehicleSelect');

            // Clear existing options except first
            while (select.options.length > 1) { select.remove(1); }

            vehicles.filter(v => v.status === 'active').forEach(v => {
                select.add(new Option(`${v.registration_number} - ${v.vehicle_type} (${v.driver_name})`, v.id));
            });
        } catch (e) { console.error('Failed to load vehicles', e); }
    }

    function openDispatchModal(id) {
        document.getElementById('dispatchSaleId').value = id;
        document.getElementById('lorryInfo').value = '';
        document.getElementById('vehicleSelect').value = '';
        document.getElementById('storeKeeperSelect').value = '';
        dispatchModal.show();
    }

    async function confirmDispatch() {
        const id = document.getElementById('dispatchSaleId').value;
        const keeperId = document.getElementById('storeKeeperSelect').value;
        const vehicleId = document.getElementById('vehicleSelect').value;
        const lorryInfo = document.getElementById('lorryInfo').value;

        if (!keeperId) {
            Swal.fire('Error', 'Please assign a store keeper', 'warning');
            return;
        }

        if (!vehicleId && !lorryInfo) {
            Swal.fire('Error', 'Please select a vehicle OR enter details manually', 'warning');
            return;
        }

        try {
            await api.post(`/api/sales/${id}/dispatch_order/`, {
                store_keeper: keeperId,
                vehicle_id: vehicleId,
                lorry_info: lorryInfo
            });
            dispatchModal.hide();
            Swal.fire('Dispatched!', 'Order has been marked as dispatched.', 'success');
            loadOrders();
            loadVehicles();
            loadInTransitVehicles();
        } catch (e) {
            console.error(e);
            let msg = 'Failed to dispatch order';
            if (e.error) {
                msg = Array.isArray(e.error) ? e.error.join('\n') : e.error;
            } else if (e.message) {
                msg = e.message;
            }
            Swal.fire('Error', msg, 'error');
        }
    }

    async function loadInTransitVehicles() {
        const list = document.getElementById('in-transit-list');
        const count = document.getElementById('in-transit-count');

        try {
            const data = await api.get('/api/vehicles/');
            const vehicles = Array.isArray(data) ? data : data.results;
            const busyVehicles = vehicles.filter(v => v.status === 'busy');

            if (count) count.innerText = busyVehicles.length;

            if (busyVehicles.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-check-circle display-4 text-success opacity-50"></i>
                        <p class="mt-3 small mb-0 fw-bold">All vehicles available</p>
                    </div>
                 `;
                return;
            }

            list.innerHTML = busyVehicles.map(v => `
                <div class="list-group-item px-3 py-3 border-0 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold text-dark">${v.registration_number}</span>
                        <span class="badge bg-warning text-dark border border-warning">In Transit</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-end">
                        <div>
                            <small class="text-muted d-block mb-1"><i class="bi bi-person-fill me-1"></i> ${v.driver_name}</small>
                            <small class="text-muted"><i class="bi bi-truck-front-fill me-1"></i> ${v.vehicle_type}</small>
                        </div>
                        <button onclick="returnVehicle(${v.id})" class="btn btn-sm btn-outline-success rounded-pill px-3">
                            <i class="bi bi-arrow-return-left me-1"></i> Return
                        </button>
                    </div>
                </div>
            `).join('');
        } catch (e) {
            console.error(e);
            if (list) list.innerHTML = '<p class="text-danger text-center py-3">Failed to load fleet</p>';
        }
    }

    async function returnVehicle(id) {
        const result = await Swal.fire({
            title: 'Confirm Return?',
            text: "This will mark the vehicle as available for new dispatches.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, Return it!'
        });

        if (!result.isConfirmed) return;

        try {
            await api.post(`/api/vehicles/${id}/return_vehicle/`);
            const toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000,
                timerProgressBar: true
            });
            toast.fire({ icon: 'success', title: 'Vehicle marked as Available' });

            loadInTransitVehicles();
            loadVehicles();
        } catch (e) {
            Swal.fire('Error', 'Failed to update vehicle status', 'error');
        }
    }
</script>
{% endblock %}