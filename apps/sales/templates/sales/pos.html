{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row h-100 g-3">
    <!-- Product Grid Section -->
    <div class="col-md-8 d-flex flex-column h-100">
        <!-- Search & Filters -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="bi bi-search text-muted"></i></span>
                            <input type="text" id="productSearch" class="form-control border-start-0 ps-0"
                                placeholder="Scan barcode or search product..." autocomplete="off">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="categoryFilter" class="form-select">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="branchSelect" class="form-select">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollable Product Grid -->
        <div class="card shadow-sm flex-grow-1 overflow-hidden" style="min-height: 0;">
            <div class="card-body overflow-auto p-3" id="productGrid">
                <div class="text-center py-5 text-muted">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading products...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div class="col-md-4 d-flex flex-column h-100">
        <div class="card shadow-sm h-100 border-0 border-start border-primary border-4">
            <div class="card-header bg-white py-3">
                <h5 class="fw-bold mb-0 text-primary"><i class="bi bi-cart3 me-2"></i>Current Sale</h5>
            </div>

            <!-- Cart Items -->
            <div class="card-body p-0 overflow-auto flex-grow-1" id="cartContainer" style="background-color: #f8f9fa;">
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-cart-x display-1 text-secondary opacity-25"></i>
                    <p class="mt-3">Cart is empty</p>
                </div>
            </div>

            <!-- Cart Footer -->
            <div class="card-footer bg-white p-3 border-top shadow-sm">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Subtotal</span>
                    <span class="fw-bold" id="cartSubtotal">TZS 0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span class="text-muted">Tax (0%)</span> <!-- Configurable later -->
                    <span class="fw-bold">TZS 0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-4">
                    <span class="h5 fw-bold text-dark">Total</span>
                    <span class="h4 fw-bold text-primary" id="cartTotal">TZS 0.00</span>
                </div>

                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg fw-bold" onclick="showPaymentModal()" id="btnCheckout"
                        disabled>
                        <i class="bi bi-credit-card me-2"></i> Proceed to Payment
                    </button>
                    <button class="btn btn-outline-danger" onclick="clearCart()" id="btnClear" disabled>
                        <i class="bi bi-trash"></i> Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Complete Payment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <h6 class="text-muted text-uppercase small">Total Amount</h6>
                    <h1 class="fw-bold text-primary display-4" id="modalTotal">TZS 0.00</h1>
                </div>

                <form id="paymentForm">
                    <div class="mb-3">
                        <a class="nav-link" href="{% url 'sales:sale_list' %}">Sales History</a>
                        <a class="nav-link" href="{% url 'sales:order_management' %}"><i
                                class="bi bi-diagram-3 me-2"></i>Order Workflow</a>
                        <a class="nav-link" href="{% url 'sales:credit_sales' %}">Credit Sales</a>
                        <label class="form-label text-muted small fw-bold">Payment Method</label>
                        <div class="row g-2" id="paymentMethods">
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="payment_method" id="payCash" value="cash"
                                    checked>
                                <label class="btn btn-outline-secondary w-100 py-3" for="payCash">
                                    <i class="bi bi-cash fs-4 d-block mb-1"></i> Cash
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="payment_method" id="payCard" value="credit">
                                <label class="btn btn-outline-secondary w-100 py-3" for="payCard">
                                    <i class="bi bi-credit-card fs-4 d-block mb-1"></i> Credit
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="payment_method" id="payTransfer"
                                    value="bank">
                                <label class="btn btn-outline-secondary w-100 py-3" for="payTransfer">
                                    <i class="bi bi-bank fs-4 d-block mb-1"></i> Bank
                                </label>
                            </div>
                            <div class="col-6">
                                <input type="radio" class="btn-check" name="payment_method" id="payMobile"
                                    value="mobile">
                                <label class="btn btn-outline-secondary w-100 py-3" for="payMobile">
                                    <i class="bi bi-phone fs-4 d-block mb-1"></i> Mobile
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Customer (Optional)</label>
                        <select class="form-select" id="customerSelect">
                            <option value="">Walk-in Customer</option>
                        </select>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-success btn-lg fw-bold py-3">
                            Confirm Payment <i class="bi bi-check-circle ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // --- State ---
    let products = [];
    let cart = [];
    let categories = [];
    let branches = [];
    let currentBranch = null;
    let customers = [];

    // --- DOM Elements ---
    const grid = document.getElementById('productGrid');
    const searchInput = document.getElementById('productSearch');
    const categorySelect = document.getElementById('categoryFilter');
    const branchSelect = document.getElementById('branchSelect');
    const cartContainer = document.getElementById('cartContainer');
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchInitialData();
        renderProductGrid(products);
        updateCartUI();

        // Listeners
        searchInput.addEventListener('input', filterProducts);
        categorySelect.addEventListener('change', filterProducts);
        branchSelect.addEventListener('change', (e) => {
            currentBranch = parseInt(e.target.value);
            filterProducts(); // In a real app we might refetch stock for this branch
            // Warning: Changing branch should verify cart items are available in new branch
            clearCart();
        });
        document.getElementById('paymentForm').addEventListener('submit', processSale);
    });

    // --- Data Fetching ---
    async function fetchInitialData() {
        try {
            // In a real optimized app, we'd fetch products with current stock for the selected branch only
            const [prodRes, catRes, branchRes, stockRes, custRes] = await Promise.all([
                fetch('/api/products/'),
                fetch('/api/categories/'),
                fetch('/api/branches/'),
                fetch('/api/stocks/'),
                fetch('/api/customers/')
            ]);

            const prodData = await prodRes.json();
            const catData = await catRes.json();
            const branchData = await branchRes.json();
            const stockData = await stockRes.json();
            const custData = await custRes.json();

            // Handle paginated or flat responses
            const productsList = Array.isArray(prodData) ? prodData : prodData.results;
            categories = Array.isArray(catData) ? catData : catData.results;
            branches = Array.isArray(branchData) ? branchData : branchData.results;
            const stocks = Array.isArray(stockData) ? stockData : stockData.results;
            customers = Array.isArray(custData) ? custData : custData.results;

            // Setup Branch Selector
            branchSelect.innerHTML = '';
            branches.forEach((b, idx) => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.text = b.name;
                branchSelect.appendChild(opt);
                if (idx === 0) currentBranch = b.id;
            });

            // Populate Products with calculated stock
            products = productsList.map(p => {
                const pStocks = stocks.filter(s => s.product === p.id);
                return { ...p, stocks: pStocks };
            });

            // Setup Categories
            categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.text = c.name;
                categorySelect.appendChild(opt);
            });

            // Setup Customers
            const custSelect = document.getElementById('customerSelect');
            custSelect.innerHTML = '<option value="">Select Customer (Optional)</option>';
            customers.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.text = `${c.name} (${c.phone || 'No phone'})`;
                custSelect.appendChild(opt);
            });

        } catch (e) {
            console.error(e);
            Swal.fire('Error', 'Failed to load POS data', 'error');
        }
    }

    // --- Rendering ---
    function renderProductGrid(data) {
        grid.innerHTML = '';
        if (data.length === 0) {
            grid.innerHTML = '<div class="text-center py-5 text-muted"><p>No products found</p></div>';
            return;
        }

        const row = document.createElement('div');
        row.className = 'row g-3';

        data.forEach(p => {
            // Get stock for current branch
            const stockEntry = p.stocks.find(s => s.branch === currentBranch);
            const stockQty = stockEntry ? stockEntry.quantity : 0;
            const hasStock = stockQty > 0;

            const col = document.createElement('div');
            col.className = 'col-6 col-md-4 col-lg-3';
            col.innerHTML = `
                <div class="card h-100 product-card shadow-sm border-0 ${hasStock ? '' : 'opacity-50'}" 
                     role="button" onclick="addToCart(${p.id})">
                    <div class="card-body p-3 d-flex flex-column text-center">
                        <div class="bg-light rounded p-3 mb-3 d-flex align-items-center justify-content-center" style="height: 100px;">
                            <i class="bi bi-box-seam fs-1 text-secondary"></i>
                        </div>
                        <h6 class="fw-bold text-truncate mb-1" title="${p.name}">${p.name}</h6>
                        <small class="text-muted mb-2 text-truncate">${p.sku}</small>
                        
                        <div class="mt-auto">
                            <h5 class="text-primary fw-bold mb-1">TZS ${parseFloat(p.price).toFixed(2)}</h5>
                            <span class="badge ${hasStock ? (stockQty < 10 ? 'bg-warning' : 'bg-success') : 'bg-danger'} rounded-pill">
                                ${hasStock ? `${stockQty} in stock` : 'Out of Stock'}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            row.appendChild(col);
        });
        grid.appendChild(row);
    }

    // --- Cart Logic ---
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;

        // Check stock
        const stockEntry = product.stocks.find(s => s.branch === currentBranch);
        const available = stockEntry ? stockEntry.quantity : 0;

        const existingItem = cart.find(i => i.id === productId);
        const currentQty = existingItem ? existingItem.qty : 0;

        if (currentQty + 1 > available) {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });
            Toast.fire({ icon: 'error', title: 'Insufficient Stock' });
            return;
        }

        if (existingItem) {
            existingItem.qty++;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: parseFloat(product.price),
                qty: 1,
                max: available
            });
        }

        updateCartUI();
    }

    function updateCartUI() {
        cartContainer.innerHTML = '';

        let subtotal = 0;

        if (cart.length === 0) {
            cartContainer.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-cart-x display-1 text-secondary opacity-25"></i>
                    <p class="mt-3">Cart is empty</p>
                </div>`;
            document.getElementById('btnCheckout').disabled = true;
            document.getElementById('btnClear').disabled = true;
        } else {
            cart.forEach(item => {
                const total = item.qty * item.price;
                subtotal += total;

                const el = document.createElement('div');
                el.className = 'p-3 border-bottom bg-white';
                el.innerHTML = `
                    <div class="d-flex justify-content-between mb-2">
                        <span class="fw-bold text-truncate" style="max-width: 60%;">${item.name}</span>
                        <span class="fw-bold">TZS ${total.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">TZS ${item.price.toFixed(2)} / unit</small>
                        <div class="input-group input-group-sm" style="width: 100px;">
                            <button class="btn btn-outline-secondary" onclick="updateQty(${item.id}, -1)">-</button>
                            <input type="text" class="form-control text-center bg-white px-0" value="${item.qty}" readonly>
                            <button class="btn btn-outline-secondary" onclick="updateQty(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `;
                cartContainer.appendChild(el);
            });
            document.getElementById('btnCheckout').disabled = false;
            document.getElementById('btnClear').disabled = false;
        }

        document.getElementById('cartSubtotal').innerText = 'TZS ' + subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
        document.getElementById('cartTotal').innerText = 'TZS ' + subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 });
    }

    function updateQty(id, delta) {
        const item = cart.find(i => i.id === id);
        if (!item) return;

        const newQty = item.qty + delta;
        if (newQty <= 0) {
            cart = cart.filter(i => i.id !== id);
        } else if (newQty > item.max) {
            Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: 'Max stock reached', timer: 1500, showConfirmButton: false });
            return;
        } else {
            item.qty = newQty;
        }
        updateCartUI();
    }

    function clearCart() {
        cart = [];
        updateCartUI();
    }

    function filterProducts() {
        const term = searchInput.value.toLowerCase();
        const catId = categorySelect.value;

        const filtered = products.filter(p => {
            const matchesTerm = p.name.toLowerCase().includes(term) || p.sku.toLowerCase().includes(term);
            const matchesCat = catId ? p.category == catId : true;
            return matchesTerm && matchesCat;
        });

        renderProductGrid(filtered);
    }

    // --- Checkout ---
    function showPaymentModal() {
        // Recalculate total
        const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
        document.getElementById('modalTotal').innerText = 'TZS ' + total.toLocaleString(undefined, { minimumFractionDigits: 2 });
        paymentModal.show();
    }

    async function processSale(e) {
        e.preventDefault();

        const custSelect = document.getElementById('customerSelect');
        const selectedOption = custSelect.selectedIndex >= 0 ? custSelect.options[custSelect.selectedIndex] : null;

        if (!currentBranch) {
            Swal.fire('Error', 'No branch selected', 'error');
            return;
        }

        const saleData = {
            branch: currentBranch,
            customer: custSelect.value || null,
            customer_name: selectedOption ? selectedOption.text : "Walk-in Customer",
            items: cart.map(i => ({
                product: i.id,
                quantity: i.qty,
                price_at_sale: i.price
            })),
            payment_details: {
                method: document.querySelector('input[name="payment_method"]:checked').value,
                amount: cart.reduce((acc, item) => acc + (item.price * item.qty), 0)
            }
        };

        try {
            const response = await fetch('/api/sales/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(saleData)
            });

            if (response.ok) {
                const sale = await response.json();
                await Swal.fire({
                    icon: 'success',
                    title: 'Order Submitted!',
                    text: 'Order is now pending Admin approval. Invoice # ' + sale.invoice_number,
                    timer: 5000,
                    showConfirmButton: true
                }).then(() => {
                    paymentModal.hide(); // Ensure modal is closed
                    // User requested to return to POS screen (which we are already on).
                });
                clearCart();
                fetchInitialData(); // Refresh stock
            } else {
                const err = await response.json();
                Swal.fire('Error', 'Transaction failed: ' + JSON.stringify(err), 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Connection error', 'error');
        }
    }

    // --- Styling fix for product card hover ---
    const style = document.createElement('style');
    style.innerHTML = `
        .product-card { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; border-color: var(--bs-primary)!important; }
    `;
    document.head.appendChild(style);

</script>
{% endblock %}