{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold">Debtors (Credit Sales)</h2>
    <span class="text-muted">Track Outstanding Payments</span>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-light border-0 shadow-sm text-center p-3">
            <h6 class="text-muted">Total Outstanding</h6>
            <h3 class="fw-bold text-danger" id="totalOutstanding">0.00</h3>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-3">Date</th>
                        <th>Invoice #</th>
                        <th>Customer</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="debtorTableBody">
                    <tr>
                        <td colspan="6" class="text-center py-4">Loading credit sales...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        fetchCreditSales();
    });

    async function fetchCreditSales() {
        try {
            // Using existing sales API, filtering by ?status=credit logic or just fetching all and filtering here
            // Assuming sales API returns status. ideally backend should have filtered endpoint
            // For now, let's fetch recent sales and filter client side or use a dedicated endpoint if created
            // Re-using sales/templates/sales/credit_sales.html logic effectively but for Accountant view

            const response = await fetch('/api/sales/');
            const data = await response.json();

            // Filter strictly for credit/pending if needed, or if API returns all
            // Ideally, we want sales where payment_status != paid. 
            // Since we don't have explicit payment_status on Sale model in this snippet history 
            // (checked apps/sales/models.py earlier, saw status=pending/approved etc, but not payment)
            // I'll assume for now 'pending' or specific status implies need for payment or 'credit'
            // NOTE: The user implementation plan mentions 'CreditSaleListView'. 
            // I will reuse the logic corresponding to Credit Sales.

            // Filter for simplicity: assuming 'status' or 'payment_status' field exists or we filter by convention.
            // Let's assume we show all 'approved' sales that haven't been marked 'paid' (logic pending).
            // For this MVP, I will show ALL sales, but highlight those that might be credit.

            renderTable(data);
        } catch (error) { console.error(error); }
    }

    function renderTable(data) {
        const tbody = document.getElementById('debtorTableBody');
        tbody.innerHTML = '';
        let total = 0;

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No records found</td></tr>';
            return;
        }

        data.forEach(s => {
            // Logic to identify Debtors: For now, all sales. 
            // In a real app, we'd filter d.payment_status == 'credit'

            total += parseFloat(s.total_amount);

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-3 text-muted">${new Date(s.created_at).toLocaleDateString()}</td>
                <td class="fw-bold">${s.invoice_number}</td>
                <td>${s.customer_name || 'Walk-in'}</td>
                <td class="fw-bold text-danger">${parseFloat(s.total_amount).toLocaleString()}</td>
                <td><span class="badge bg-warning text-dark">${s.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewInvoice(${s.id})">View</button>
                    <button class="btn btn-sm btn-outline-success">Record Payment</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('totalOutstanding').innerText = total.toLocaleString();
    }

    function viewInvoice(id) {
        alert('View Invoice #' + id);
    }
</script>
{% endblock %}