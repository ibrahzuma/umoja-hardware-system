{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-6 offset-md-3">
        <div class="card shadow-sm border-0 border-top border-primary border-4">
            <div class="card-header bg-white py-3">
                <h4 class="fw-bold text-primary mb-0"><i class="bi bi-shield-plus me-2"></i>Create New Role</h4>
            </div>
            <div class="card-body">
                <form id="roleForm">
                    <div class="mb-4">
                        <label class="form-label fw-bold">Role Name</label>
                        <input type="text" class="form-control form-control-lg" id="name"
                            placeholder="e.g. Sales Manager" required>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Assign Permissions</label>
                        <div id="permissionsContainer" class="row">
                            <div class="col-12 text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2">Loading permissions...</span>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid mt-4">
                        <button type="submit" class="btn btn-primary btn-lg fw-bold">
                            <i class="bi bi-shield-check me-2"></i>Save Role
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('permissionsContainer');
        const urlParams = new URLSearchParams(window.location.search);
        const roleId = urlParams.get('id');

        if (roleId) {
            document.querySelector('h4').innerHTML = '<i class="bi bi-pencil-square me-2"></i>Edit Role';
            document.querySelector('button[type="submit"]').innerHTML = '<i class="bi bi-check2-circle me-2"></i>Update Role';
        }

        try {
            const [permRes, roleDataRes] = await Promise.all([
                fetch('/api/permissions/'),
                roleId ? fetch(`/api/roles/${roleId}/`) : Promise.resolve(null)
            ]);

            const perms = await permRes.json();
            const existingRole = roleDataRes ? await roleDataRes.json() : null;

            if (existingRole) {
                document.getElementById('name').value = existingRole.name;
            }

            container.innerHTML = '';

            // Group permissions by app/model
            const groups = {};
            perms.forEach(p => {
                const groupKey = `${p.app_label} - ${p.model}`;
                if (!groups[groupKey]) groups[groupKey] = [];
                groups[groupKey].push(p);
            });

            for (const [groupName, groupPerms] of Object.entries(groups)) {
                const groupCol = document.createElement('div');
                groupCol.className = 'col-md-6 mb-4';

                let permHtml = `
                    <div class="card h-100 border-0 shadow-sm bg-light">
                        <div class="card-body">
                            <h6 class="fw-bold text-dark text-capitalize mb-3 border-bottom pb-2">
                                <i class="bi bi-folder2-open me-2 text-primary"></i>${groupName.replace('-', ' Â» ')}
                            </h6>
                            <div class="row g-2">
                `;

                groupPerms.forEach(p => {
                    const isChecked = existingRole && existingRole.permissions.includes(p.id) ? 'checked' : '';
                    permHtml += `
                        <div class="col-6">
                            <div class="form-check custom-checkbox">
                                <input class="form-check-input perm-check" type="checkbox" value="${p.id}" id="perm_${p.id}" ${isChecked}>
                                <label class="form-check-label small" for="perm_${p.id}">
                                    ${p.name.split('|').pop().trim()}
                                </label>
                            </div>
                        </div>
                    `;
                });

                permHtml += `</div></div></div>`;
                groupCol.innerHTML = permHtml;
                container.appendChild(groupCol);
            }

        } catch (e) {
            console.error(e);
            container.innerHTML = '<div class="alert alert-danger">Failed to load permissions</div>';
        }

        document.getElementById('roleForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedPerms = Array.from(document.querySelectorAll('.perm-check:checked')).map(cb => cb.value);

            const data = {
                name: document.getElementById('name').value,
                permissions: selectedPerms
            };

            const method = roleId ? 'PUT' : 'POST';
            const url = roleId ? `/api/roles/${roleId}/` : '/api/roles/';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: roleId ? 'Role Updated' : 'Role Created',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.href = "{% url 'role_list' %}";
                    });
                } else {
                    Swal.fire('Error', 'Failed to save role', 'error');
                }
            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'Connection failed', 'error');
            }
        });
    });
</script>

<style>
    .custom-checkbox .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .form-check-label {
        cursor: pointer;
        user-select: none;
    }

    .card:hover {
        transform: translateY(-2px);
        transition: transform 0.2s;
    }
</style>
{% endblock %}