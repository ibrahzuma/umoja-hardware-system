{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary fw-bold">Import Products</h2>
    <a href="{% url 'inventory:products_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to List
    </a>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body p-5 text-center">
                <i class="bi bi-cloud-upload display-1 text-primary opacity-50"></i>
                <h4 class="mt-3">Upload CSV or Excel File</h4>
                <p class="text-muted">Ensure your file matches the template format.</p>

                <form id="importForm" class="mt-4">
                    {% csrf_token %}
                    <input type="file" id="fileInput" class="form-control mb-3" accept=".csv, .xlsx" required>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload"></i> Upload File
                        </button>
                    </div>
                </form>

                <div class="mt-4 text-start">
                    <h5>Instructions:</h5>
                    <ul class="text-muted small">
                        <li>File must contain headers: <strong>Name, Category, Cost, Price, Opening Stock, Low
                                Stock Alert</strong> (SKU is optional and will be generated if missing).</li>
                        <li>Category must exist in the system beforehand.</li>
                        <li>Duplicate SKUs will be skipped.</li>
                    </ul>
                    <a href="{% url 'inventory:download_product_template' %}" class="btn btn-sm btn-link">Download
                        Template</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    document.getElementById('importForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire('Error', 'Please select a file', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        Swal.fire({
            title: 'Uploading...',
            text: 'Please wait while we process your file',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        try {
            const resp = await fetch('/api/products/import/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });

            const data = await resp.json();

            if (resp.ok) {
                let msg = data.message || 'Products imported successfully';
                if (data.errors && data.errors.length > 0) {
                    msg += '<br><br><strong>Issues found:</strong><br>' + data.errors.join('<br>');
                    Swal.fire({
                        title: 'Import Finished with Issues',
                        html: msg,
                        icon: 'warning'
                    }).then(() => {
                        window.location.href = "{% url 'inventory:products_list' %}";
                    });
                } else {
                    Swal.fire('Success', msg, 'success').then(() => {
                        window.location.href = "{% url 'inventory:products_list' %}";
                    });
                }
            } else {
                let errorMsg = data.error || 'Failed to import products';
                if (data.errors && data.errors.length > 0) {
                    errorMsg += '\n' + data.errors.join('\n');
                }
                Swal.fire('Error', errorMsg, 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'Connection error while uploading: ' + error.message, 'error');
        }
    });
</script>
{% endblock %}